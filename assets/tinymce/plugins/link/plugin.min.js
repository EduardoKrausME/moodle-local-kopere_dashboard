tinymce.PluginManager.add("link",function(d){function b(e){return function(){var f=d.settings.link_list;if(typeof f=="string"){tinymce.util.XHR.send({url:f,success:function(g){e(tinymce.util.JSON.parse(g))}})}else{if(typeof f=="function"){f(e)}else{e(f)}}}}function c(g,e,h){function f(j,i){i=i||[];tinymce.each(j,function(l){var k={text:l.text||l.title};if(l.menu){k.menu=f(l.menu)}else{k.value=l.value;if(e){e(k)}}i.push(k)});return i}return f(g,h||[])}function a(j){var x={},y=d.selection,t=d.dom,v,n,o;var i,l,k,g,p,m,h,q,r;function u(z){var A=i.find("#text");if(!A.value()||(z.lastControl&&A.value()==z.lastControl.text())){A.value(z.control.text())}i.find("#href").value(z.control.value())}function f(z){var A=[];tinymce.each(d.dom.select("a:not([href])"),function(B){var C=B.name||B.id;if(C){A.push({text:C,value:"#"+C,selected:z.indexOf("#"+C)!=-1})}});if(A.length){A.unshift({text:"None",value:""});return{name:"anchor",type:"listbox",label:"Anchors",values:A,onselect:u}}}function s(){if(!o&&x.text.length===0&&l){this.parent().parent().find("#text")[0].value(this.value())}}function e(A){var z=A.meta||{};if(g){g.value(d.convertURL(this.value(),"href"))}tinymce.each(A.meta,function(C,B){i.find("#"+B).value(C)});if(!z.text){s.call(this)}}function w(A){var C=y.getContent();if(/</.test(C)&&(!/^<a [^>]+>[^<]+<\/a>$/.test(C)||C.indexOf("href=")==-1)){return false}if(A){var z=A.childNodes,B;if(z.length===0){return false}for(B=z.length-1;B>=0;B--){if(z[B].nodeType!=3){return false}}}return true}v=y.getNode();n=t.getParent(v,"a[href]");l=w();x.text=o=n?(n.innerText||n.textContent):y.getContent({format:"text"});x.href=n?t.getAttrib(n,"href"):"";if(n){x.target=t.getAttrib(n,"target")}else{if(d.settings.default_link_target){x.target=d.settings.default_link_target}}if((r=t.getAttrib(n,"rel"))){x.rel=r}if((r=t.getAttrib(n,"class"))){x["class"]=r}if((r=t.getAttrib(n,"title"))){x.title=r}if(l){k={name:"text",type:"textbox",size:40,label:"Text to display",onchange:function(){x.text=this.value()}}}if(j){g={type:"listbox",label:"Link list",values:c(j,function(z){z.value=d.convertURL(z.value||z.url,"href")},[{text:"None",value:""}]),onselect:u,value:d.convertURL(x.href,"href"),onPostRender:function(){g=this}}}if(d.settings.target_list!==false){if(!d.settings.target_list){d.settings.target_list=[{text:"None",value:""},{text:"New window",value:"_blank"}]}m={name:"target",type:"listbox",label:"Target",values:c(d.settings.target_list)}}if(d.settings.rel_list){p={name:"rel",type:"listbox",label:"Rel",values:c(d.settings.rel_list)}}if(d.settings.link_class_list){h={name:"class",type:"listbox",label:"Class",values:c(d.settings.link_class_list,function(z){if(z.value){z.textStyle=function(){return d.formatter.getCssText({inline:"a",classes:[z.value]})}}})}}if(d.settings.link_title!==false){q={name:"title",type:"textbox",label:"Title",value:x.title}}i=d.windowManager.open({title:"Insert link",data:x,body:[{name:"href",type:"filepicker",filetype:"file",size:40,autofocus:true,label:"Url",onchange:e,onkeyup:s},k,q,f(x.href),g,p,m,h],onSubmit:function(C){var z;x=tinymce.extend(x,C.data);z=x.href;function B(E,F){var D=d.selection.getRng();window.setTimeout(function(){d.windowManager.confirm(E,function(G){d.selection.setRng(D);F(G)})},0)}function A(){var D={href:z,target:x.target?x.target:null,rel:x.rel?x.rel:null,"class":x["class"]?x["class"]:null,title:x.title?x.title:null};if(n){d.focus();if(l&&x.text!=o){if("innerText" in n){n.innerText=x.text}else{n.textContent=x.text}}t.setAttribs(n,D);y.select(n);d.undoManager.add()}else{if(l){d.insertContent(t.createHTML("a",D,t.encode(x.text)))}else{d.execCommand("mceInsertLink",false,D)}}}if(!z){d.execCommand("unlink");return}if(z.indexOf("@")>0&&z.indexOf("//")==-1&&z.indexOf("mailto:")==-1){B("The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?",function(D){if(D){z="mailto:"+z}A()});return}if((d.settings.link_assume_external_targets&&!/^\w+:/i.test(z))||(!d.settings.link_assume_external_targets&&/^\s*www\./i.test(z))){B("The URL you entered seems to be an external link. Do you want to add the required http:// prefix?",function(D){if(D){z="http://"+z}A()});return}A()}})}d.addButton("link",{icon:"link",tooltip:"Insert/edit link",shortcut:"Meta+K",onclick:b(a),stateSelector:"a[href]"});d.addButton("unlink",{icon:"unlink",tooltip:"Remove link",cmd:"unlink",stateSelector:"a[href]"});d.addShortcut("Meta+K","",b(a));d.addCommand("mceLink",b(a));this.showDialog=a;d.addMenuItem("link",{icon:"link",text:"Insert/edit link",shortcut:"Meta+K",onclick:b(a),stateSelector:"a[href]",context:"insert",prependToContext:true})});