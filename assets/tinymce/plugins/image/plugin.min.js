tinymce.PluginManager.add("image",function(e){function c(h,j){var g=document.createElement("img");function f(l,k){if(g.parentNode){g.parentNode.removeChild(g)}j({width:l,height:k})}g.onload=function(){f(Math.max(g.width,g.clientWidth),Math.max(g.height,g.clientHeight))};g.onerror=function(){f()};var i=g.style;i.visibility="hidden";i.position="fixed";i.bottom=i.left=0;i.width=i.height="auto";document.body.appendChild(g);g.src=h}function d(h,f,i){function g(k,j){j=j||[];tinymce.each(k,function(m){var l={text:m.text||m.title};if(m.menu){l.menu=g(m.menu)}else{l.value=m.value;f(l)}j.push(l)});return j}return g(h,i||[])}function b(f){return function(){var g=e.settings.image_list;if(typeof g=="string"){tinymce.util.XHR.send({url:g,success:function(h){f(tinymce.util.JSON.parse(h))}})}else{if(typeof g=="function"){g(f)}else{f(g)}}}}function a(q){var k,x={},s=e.dom,g=e.selection.getNode();var p,n,t,i,l=e.settings.image_dimensions!==false;function f(){var z,B,A,y;z=k.find("#width")[0];B=k.find("#height")[0];if(!z||!B){return}A=z.value();y=B.value();if(k.find("#constrain")[0].checked()&&p&&n&&A&&y){if(p!=A){y=Math.round((A/p)*y);if(!isNaN(y)){B.value(y)}}else{A=Math.round((y/n)*A);if(!isNaN(A)){z.value(A)}}}p=A;n=y}function m(){function y(A){function z(){A.onload=A.onerror=null;if(e.selection){e.selection.select(A);e.nodeChanged()}}A.onload=function(){if(!x.width&&!x.height&&l){s.setAttribs(A,{width:A.clientWidth,height:A.clientHeight})}z()};A.onerror=z}o();f();x=tinymce.extend(x,k.toJSON());if(!x.alt){x.alt=""}if(!x.align){x.align=""}if(!x.classe){x.classe=""}if(!x.title){x.title=""}if(x.width===""){x.width=null}if(x.height===""){x.height=null}if(!x.style){x.style=null}x={src:x.src,alt:x.alt,align:x.align,title:x.title,width:x.width,height:x.height,style:x.style,"class":x.classe};e.undoManager.transact(function(){if(!x.src){if(g){s.remove(g);e.focus();e.nodeChanged()}return}if(x.title===""){x.title=null}if(!g){x.id="__mcenew";e.focus();e.selection.setContent(s.createHTML("img",x));g=s.get("__mcenew");s.setAttrib(g,"id",null)}else{s.setAttribs(g,x)}y(g)})}function w(y){if(y){y=y.replace(/px$/,"")}return y}function r(B){var C,z,y,A=B.meta||{};if(t){t.value(e.convertURL(this.value(),"src"))}tinymce.each(A,function(E,D){k.find("#"+D).value(E)});if(!A.width&&!A.height){C=e.convertURL(this.value(),"src");z=e.settings.image_prepend_url;y=new RegExp("^(?:[a-z]+:)?//","i");if(z&&!y.test(C)&&C.substring(0,z.length)!==z){C=z+C}this.value(C);c(e.documentBaseURI.toAbsolute(this.value()),function(D){if(D.width&&D.height&&l){p=D.width;n=D.height;k.find("#width").value(p);k.find("#height").value(n)}})}}p=s.getAttrib(g,"width");n=s.getAttrib(g,"height");if(g.nodeName=="IMG"&&!g.getAttribute("data-mce-object")&&!g.getAttribute("data-mce-placeholder")){x={src:s.getAttrib(g,"src"),alt:s.getAttrib(g,"alt"),align:s.getAttrib(g,"align"),title:s.getAttrib(g,"title"),classe:s.getAttrib(g,"class"),width:p,height:n}}else{g=null}if(q){t={type:"listbox",label:"Image list",values:d(q,function(y){y.value=e.convertURL(y.value||y.url,"src")},[{text:"None",value:""}]),value:x.src&&e.convertURL(x.src,"src"),onselect:function(y){var z=k.find("#alt");if(!z.value()||(y.lastControl&&z.value()==y.lastControl.text())){z.value(y.control.text())}k.find("#src").value(y.control.value()).fire("change")},onPostRender:function(){t=this}}}if(e.settings.image_class_list){i={name:"class",type:"listbox",label:"Class",values:d(e.settings.image_class_list,function(y){if(y.value){y.textStyle=function(){return e.formatter.getCssText({inline:"img",classes:[y.value]})}}})}}var v=[{name:"src",type:"filepicker",filetype:"image",label:"Source",autofocus:true,onchange:r},t];if(e.settings.image_description!==false){v.push({name:"alt",type:"textbox",label:"Image description"})}if(e.settings.image_title){v.push({name:"title",type:"textbox",label:"Image Title"})}if(l){v.push({type:"container",label:"Dimensions",layout:"flex",direction:"row",align:"center",spacing:5,items:[{name:"width",type:"textbox",maxLength:5,size:3,onchange:f,ariaLabel:"Width"},{type:"label",text:"x"},{name:"height",type:"textbox",maxLength:5,size:3,onchange:f,ariaLabel:"Height"},{name:"constrain",type:"checkbox",checked:true,text:"Constrain proportions"}]});v.push({name:"align",type:"listbox",label:"Alinhamento",values:j([{text:"None",value:""},{text:"left",value:"left"},{text:"right",value:"right"},{text:"middle",value:"middle"},{text:"top",value:"top"},{text:"bottom",value:"bottom"}])});v.push({name:"classe",type:"textbox",label:"Classe CSS"})}v.push(i);function j(A,y,B){function z(D,C){C=C||[];tinymce.each(D,function(F){var E={text:F.text||F.title};if(F.menu){E.menu=z(F.menu)}else{E.value=F.value;if(y){y(E)}}C.push(E)});return C}return z(A,B||[])}function u(z){if(z.margin){var y=z.margin.split(" ");switch(y.length){case 1:z["margin-top"]=z["margin-top"]||y[0];z["margin-right"]=z["margin-right"]||y[0];z["margin-bottom"]=z["margin-bottom"]||y[0];z["margin-left"]=z["margin-left"]||y[0];break;case 2:z["margin-top"]=z["margin-top"]||y[0];z["margin-right"]=z["margin-right"]||y[1];z["margin-bottom"]=z["margin-bottom"]||y[0];z["margin-left"]=z["margin-left"]||y[1];break;case 3:z["margin-top"]=z["margin-top"]||y[0];z["margin-right"]=z["margin-right"]||y[1];z["margin-bottom"]=z["margin-bottom"]||y[2];z["margin-left"]=z["margin-left"]||y[1];break;case 4:z["margin-top"]=z["margin-top"]||y[0];z["margin-right"]=z["margin-right"]||y[1];z["margin-bottom"]=z["margin-bottom"]||y[2];z["margin-left"]=z["margin-left"]||y[3]}delete z.margin}return z}function o(){function A(B){if(B.length>0&&/^[0-9]+$/.test(B)){B+="px"}return B}if(!e.settings.image_advtab){return}var z=k.toJSON(),y=s.parseStyle(z.style);y=u(y);if(z.vspace){y["margin-top"]=y["margin-bottom"]=A(z.vspace)}if(z.hspace){y["margin-left"]=y["margin-right"]=A(z.hspace)}if(z.border){y["border-width"]=A(z.border)}k.find("#style").value(s.serializeStyle(s.parseStyle(s.serializeStyle(y))))}function h(){if(!e.settings.image_advtab){return}var z=k.toJSON(),y=s.parseStyle(z.style);k.find("#vspace").value("");k.find("#hspace").value("");y=u(y);if((y["margin-top"]&&y["margin-bottom"])||(y["margin-right"]&&y["margin-left"])){if(y["margin-top"]===y["margin-bottom"]){k.find("#vspace").value(w(y["margin-top"]))}else{k.find("#vspace").value("")}if(y["margin-right"]===y["margin-left"]){k.find("#hspace").value(w(y["margin-right"]))}else{k.find("#hspace").value("")}}if(y["border-width"]){k.find("#border").value(w(y["border-width"]))}k.find("#style").value(s.serializeStyle(s.parseStyle(s.serializeStyle(y))))}if(e.settings.image_advtab){if(g){if(g.style.marginLeft&&g.style.marginRight&&g.style.marginLeft===g.style.marginRight){x.hspace=w(g.style.marginLeft)}if(g.style.marginTop&&g.style.marginBottom&&g.style.marginTop===g.style.marginBottom){x.vspace=w(g.style.marginTop)}if(g.style.borderWidth){x.border=w(g.style.borderWidth)}x.style=e.dom.serializeStyle(e.dom.parseStyle(e.dom.getAttrib(g,"style")))}k=e.windowManager.open({title:"Insert/edit image",data:x,bodyType:"tabpanel",body:[{title:"General",type:"form",items:v},{title:"Advanced",type:"form",pack:"start",items:[{label:"Style",name:"style",type:"textbox",onchange:h},{type:"form",layout:"grid",packV:"start",columns:2,padding:0,alignH:["left","right"],defaults:{type:"textbox",maxWidth:50,onchange:o},items:[{label:"Vertical space",name:"vspace"},{label:"Horizontal space",name:"hspace"},{label:"Border",name:"border"}]}]}],onSubmit:m})}else{k=e.windowManager.open({title:"Insert/edit image",data:x,body:v,onSubmit:m})}}e.addButton("image",{icon:"image",tooltip:"Insert/edit image",onclick:b(a),stateSelector:"img:not([data-mce-object],[data-mce-placeholder])"});e.addMenuItem("image",{icon:"image",text:"Insert/edit image",onclick:b(a),context:"insert",prependToContext:true});e.addCommand("mceImage",b(a))});